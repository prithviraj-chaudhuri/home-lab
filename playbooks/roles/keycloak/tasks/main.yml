- name: Copy keycloak files in
  copy: 
    src: keycloak/{{ item }}
    dest: /home/ansible-user/keycloak/
  loop:
    - docker-compose.yml
    - secrets/.env
  
- name: Create directories {{ item }}
  ansible.builtin.file:
    path: /home/ansible-user/keycloak/{{ item }}
    state: directory
  loop:
    - data
    - data/import

- name: Copy realm.json file to the volume
  copy: 
    src: keycloak/secrets/realm.json
    dest: /home/ansible-user/keycloak/data/import

- name: Change mounted volume permissions
  shell: chown -R 1000:1000 /home/ansible-user/keycloak/{{ item }} && chmod -R 755 /home/ansible-user/keycloak/{{ item }}
  loop:
    - data

- name: Remove keycloak
  shell: cd keycloak && docker compose down && docker compose rm
  ignore_errors: yes

- name: Setup keycloak
  shell: cd keycloak && docker compose up -d