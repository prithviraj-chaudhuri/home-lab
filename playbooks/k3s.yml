---
- name: Install Kubernetes
  hosts: controllers
  remote_user: ansible-user
  become: yes
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
  - name: Install curl
    apt:
      name: curl
      state: present

  - name: Install k3s
    shell: curl -sfL https://get.k3s.io | sh -

  - name: Allow all access to tcp port 6443
    community.general.ufw:
      rule: allow
      port: '6443'
      proto: tcp

  - name: Install Helm
    shell: curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && chmod 700 get_helm.sh && ./get_helm.sh

  - name: Add Kubernetes Dashboard repo
    kubernetes.core.helm_repository:
      name: kubernetes-dashboard
      repo_url: "https://kubernetes.github.io/dashboard/"
  
  - name: Deploy Kubernetes Dashboard
    kubernetes.core.helm:
      name: kubernetes-dashboard
      chart_ref: kubernetes-dashboard/kubernetes-dashboard
      release_namespace: kubernetes-dashboard
      create_namespace: true